<!-- Deletion notice -->
<span ng-if="!vm.editing && vm.annotation.deleted">Annotation deleted.</span>

<!-- Excerpts -->
<div class="excerpt" ng-repeat="target in vm.annotation.target">
  <blockquote class="annotation-quote"
              ng-bind-html="target.quote"
              ng-hide="target.showDiff" />
  <blockquote class="annotation-quote"
              ng-bind-html="target.trustedDiffHTML"
              ng-show="target.showDiff" />
  <label ng-show="target.diffHTML">
    Show differences
    <input class="small pull-right"
           type="checkbox"
           ng-model="target.showDiff"
           ng-click="$event.stopPropagation()" />
  </label>
</div>

<!-- Preface -->
<header>
  <!-- Privacy -->
  <privacy ng-if="vm.editing && action != 'delete'"
           ng-model="vm.annotation.permissions"
           class="dropdown privacy pull-right"
           name="privacy" />

  <!-- User -->
  <span ng-if="!vm.editing">
    <username user="vm.annotation.user"></username>
    <i class="small icon-locked"
       ng-hide="vm.authorize('read', 'group:__world__')"></i>
    <i class="small icon-highlighter2"
       ng-hide="vm.annotation.text ||
                vm.annotation.deleted ||
                vm.annotation.tags.length"></i>
    <i class="small icon-comment3"
       ng-hide="vm.annotation.target.length || vm.annotation.references"></i>
    <span class="annotation-citation"
          ng-if="!vm.embedded"
          ng-show="vm.document.title">
      on &ldquo;<a href="{{vm.document.uri}}" target="_blank"
                   >{{vm.document.title}}</a>&rdquo;
      <span class="annotation-citation-domain"
            ng-show="vm.document.domain != vm.document.title"
            >({{vm.document.domain}})</span>
    </span>
  </span>

  <!-- Timestamp -->
  <fuzzytime class="small pull-right"
             ng-show="!vm.editing && vm.annotation.updated"
             ng-model="vm.annotation.updated"></fuzzytime>

  <!-- More actions -->
  <div class="annotation-actions dropdown pull-right small"
       ng-if="vm.annotation.id && !vm.editing">
    <i class="dropdown-toggle icon-triangle"
       role="button"
       title="More actions"></i>
    <ul class="dropdown-menu" role="menu">
      <li ng-show="vm.authorize('update')"
          ng-click="vm.edit()"
          ><i class="icon-copy"></i> Edit</li>
      <li ng-show="vm.authorize('delete')"
          ng-click="vm.delete()"
          ><i class="icon-x"></i> Delete…</li>
    </ul>
  </div>
</header>

<!-- Prompt -->
<!-- TODO: replace with placeholder on markdown elements? -->
<div ng-show="vm.annotation.deleted" ng-switch="vm.editing">
  <strong ng-switch-when="true">You may provide an explanation here.</strong>
  <div count="vm.annotation.text.length"
       when="{'0': '(no reason given)',
              one: 'Reason:',
              other: 'Reason:'}"
       ng-pluralize ng-switch-default></div>
</div>

<!-- Body Write / Preview Tabs -->
<a class="icon-markdown pull-left"
   target="_blank"
   title="Parsed as Markdown"
   href="https://guides.github.com/features/mastering-markdown/"
   ng-click="$event.stopPropagation()"
   ng-if="vm.editing" />
<div class="tabbable"
     ng-model="vm.preview"
     ng-if="vm.editing">
  <div class="tab-pane" data-value="no" data-title="Write">
    <markdown class="form-field" ng-model="vm.annotation.text" name="text" />
  </div>
  <div class="tab-pane" data-value="yes" data-title="Preview">
    <p class="form-field" ng-show="!vm.annotation.text">Nothing to preview.</p>
    <markdown class="form-field" name="text"
              ng-model="vm.annotation.text"
              ng-readonly="true" />
  </div>
</div>

<markdown class="form-field" name="text"
          ng-if="!vm.editing"
          ng-model="vm.annotation.text"
          ng-readonly="true" />

<!-- Tags -->
<div class="form-field" ng-if="vm.editing">
  <tags-input ng-model="vm.annotation.tags"
              name="tags"
              class="tags"
              placeholder="Add tags…"
              replace-spaces-with-dashes="false"
              enable-editing-last-tag="true"></tags-input>
</div>

<div class="tags tags-read-only"
     ng-if="vm.annotation.tags.length && !vm.editing">
  <ul class="tag-list">
    <li class="tag-item" ng-repeat="tag in vm.annotation.tags">
      <a href="/stream?q=tag:'{{tag.text}}'" target="_blank">{{tag.text}}</a>
    </li>
  </ul>
</div>

<!-- Bottom controls -->
<div class="form-actions" ng-if="vm.editing">
  <div class="form-actions-buttons form-actions-left" ng-switch="action">
    <ng-switch on="action">
      <button ng-switch-when="edit"
              ng-click="vm.save(); $event.stopPropagation()"
              class="btn"><i class="icon-checkmark2 btn-icon"></i> Save</button>
      <button ng-switch-when="delete"
              ng-click="vm.save(); $event.stopPropagation()"
              class="btn"><i class="icon-checkmark2 btn-icon"></i> Delete</button>
      <button ng-switch-default
              ng-click="vm.save(); $event.stopPropagation()"
              class="btn"><i class="icon-checkmark2 btn-icon"></i> Save</button>
    </ng-switch>
    <button class="btn btn-clean"
            ng-click="vm.revert(); $event.stopPropagation()"
            ><i class="icon-x btn-icon"></i> Cancel</button>
  </div>
</div>
