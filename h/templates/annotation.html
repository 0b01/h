<header>
  <!-- Deletion notice -->
  <span ng-if="!vm.editing && vm.annotation.deleted">Annotation deleted.</span>

  <!-- User -->
  <span ng-if="!vm.editing && vm.annotation.user">
    <username user="vm.annotation.user"></username>
    <i class="small icon-locked"
       ng-hide="vm.authorize('read', 'group:__world__')"></i>
    <i class="small icon-highlighter2"
       ng-hide="vm.annotation.text ||
                vm.annotation.deleted ||
                vm.annotation.tags.length"></i>
    <i class="small icon-comment3"
       ng-hide="vm.annotation.target.length || vm.annotation.references"></i>
    <span class="annotation-citation"
          ng-if="!vm.embedded"
          ng-show="vm.document.title">
      on &ldquo;<a href="{{vm.document.uri}}" target="_blank"
                   >{{vm.document.title}}</a>&rdquo;
      <span class="annotation-citation-domain"
            ng-show="vm.document.domain != vm.document.title"
            >({{vm.document.domain}})</span>
    </span>
  </span>

  <!-- Timestamp -->
  <fuzzytime class="small pull-right"
             ng-show="!vm.editing && vm.annotation.updated"
             ng-model="vm.annotation.updated"></fuzzytime>
</header>

<!-- Excerpts -->
<section ng-repeat="target in vm.annotation.target">
  <blockquote class="annotation-quote"
              ng-repeat="target in vm.annotation.target"
              ng-bind-html="target.quote"
              ng-if="!target.showDiff">
  <blockquote class="annotation-quote"
              ng-bind-html="target.trustedDiffHTML"
              ng-if="target.showDiff">
  <label ng-if="target.diffHTML">
    Show differences
    <input class="small pull-right"
           type="checkbox"
           ng-model="target.showDiff" />
  </label>
</section>
<!-- / Excerpts -- >

<!-- Editing controls -->
<aside class="pull-right" ng-if="vm.editing">
  <a class="icon-markdown pull-right"
   target="_blank"
   title="Parsed as Markdown"
   href="https://guides.github.com/features/mastering-markdown/"
   ng-if="vm.editing"></a>
  <privacy ng-if="vm.annotation.permissions && vm.editing && action != 'delete'"
           ng-model="vm.annotation.permissions"
           class="dropdown privacy pull-right"
           name="privacy" />
</aside>
<!-- / Editing controls -->

<!-- Body -->
<section class="tabbable"
         ng-model="vm.preview"
         ng-if="vm.editing">
  <div class="tab-pane" data-value="no" data-title="Write">
    <div class="form-field"
         ng-model="vm.annotation.text"
         name="text"
         markdown>
    </div>
  </div>
  <div class="tab-pane" data-value="yes" data-title="Preview">
    <p class="form-field" ng-show="!vm.annotation.text">Nothing to preview.</p>
    <div class="form-field"
         name="text"
         ng-model="vm.annotation.text"
         ng-readonly="true"
         markdown>
    </div>
  </div>
</section>

<section name="text"
         ng-if="!vm.editing"
         ng-model="vm.annotation.text"
         ng-readonly="true"
         markdown>
</section>
<!-- / Body -->

<!-- Tags -->
<div class="form-field" ng-if="vm.editing">
  <tags-input ng-model="vm.annotation.tags"
              name="tags"
              class="tags"
              placeholder="Add tags…"
              replace-spaces-with-dashes="false"
              enable-editing-last-tag="true"></tags-input>
</div>

<div class="tags tags-read-only"
     ng-if="vm.annotation.tags.length && !vm.editing">
  <ul class="tag-list">
    <li class="tag-item" ng-repeat="tag in vm.annotation.tags">
      <a href="/stream?q=tag:'{{tag.text}}'" target="_blank">{{tag.text}}</a>
    </li>
  </ul>
</div>
<!-- / Tags -->

<footer class="form-actions"
        ng-click="$event.stopPropagation()"
        ng-switch="vm.action">
  <div ng-show="vm.annotation.id" ng-switch-when="view">
    <a class="small magicontrol" href="" title="Reply"
       ng-click="vm.reply()"
       ><i class="icon-reply"></i> Reply</a>
    <a class="small magicontrol" href="" title="Share"
       ng-click="vm.toggleShared()"
       ><i class="icon-export"></i> Share</a>
    <a class="small magicontrol" href="" title="Edit"
       ng-show="vm.authorize('update')"
       ng-click="vm.edit()"
       ><i class="icon-copy"></i> Edit</a>
    <a class="small magicontrol" href="" title="Delete"
       ng-show="vm.authorize('delete')"
       ng-click="vm.delete()"
       ><i class="icon-x"></i> Delete…</a>
    <div class="share-dialog" ng-show="vm.shared">
      <a class="icon-export"
         target="_blank"
         ng-href="{{baseURI}}a/{{vm.annotation.id}}"></a>
      <div>
        <input type="text"
               ng-blur="vm.toggleShared()"
               value="{{baseURI}}a/{{vm.annotation.id}}"
               readonly>
      </div>
    </div>
  </div>
  <div class="form-actions-buttons form-actions-left" ng-if="vm.editing">
    <button ng-switch-when="edit"
            ng-click="vm.save()"
            class="btn"><i class="icon-checkmark2 btn-icon"></i> Save</button>
    <button ng-switch-when="delete"
            ng-click="vm.save()"
            class="btn"><i class="icon-checkmark2 btn-icon"></i> Delete</button>
    <button ng-switch-default
            ng-click="vm.save()"
            class="btn"><i class="icon-checkmark2 btn-icon"></i> Save</button>
    <button class="btn btn-clean"
            ng-click="vm.revert()"
            ><i class="icon-x btn-icon"></i> Cancel</button>
  </div>
</footer>
