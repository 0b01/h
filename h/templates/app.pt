<metal:main use-macro="load: base.pt">

<metal:main fill-slot="head">
    <link rel="stylesheet"
          tal:attributes="href href"
          tal:repeat="href webassets(request, 'app_css') | []" />
</metal:main>

<metal:main fill-slot="body">

  <div id="toolbar">
    <img class="tab-logo"
         src="${request.static_url('h:images/hbar-logo-small.png')}" />
    <form tal:replace="structure form['persona']"/>
  </div>

  <div id="wrapper">
    <header tal:attributes="style request.user and 'display: none' | nothing"
            class="annotator-outer">
      <div class="hyp-paper">
        <span metal:use-macro="auth" tal:define="auth load: auth.pt" />
      </div>
    </header>
  </div>

  <script tal:attributes="src src"
          tal:repeat="src webassets(
                      request,
                      'annotator',
                      'd3',
                      'easyXDM',
                      'handlebars',
                      'jwz',
                      'templates',
                      'underscore')"></script>
  <script>
    var annotator = window.Annotator._instance = new Hypothesis(document.body, {
      Heatmap: {}
    })

    var setupAuth = function () {
      if (!annotator.plugins.Auth) {
        annotator.addPlugin('Auth', {
          autoFetch: false,
          tokenUrl: '${request.route_url('token')}'
        })
      }

      annotator.plugins.Auth.withToken(function (token) {
        annotator.plugins.Permissions.setUser(token.userId);
      })
    }

    var setupPersona = function () {
      $('select').filter('[name^="persona"]').change(function (e) {
        if (e.target.value == -1) {
          var annotator = window.Annotator._instance
          try {
            annotator.plugins.Permissions.setUser(null)
            // FIXME: always throws
            annotator.plugins.Auth.setToken(null)
          } catch(e) { }
          annotator.plugins.Auth.updateHeaders()
        }

        $(e.target).parents('form:first').submit()
      })
    }

    var loginSuccess = function (data) {
      var auth = $(data.form.auth).replaceAll('#auth')
      var persona = $(data.form.persona).replaceAll('#persona')
      // TODO: somehow avoid calling the success function on errors
      if (auth.find('.alert-error').length == 0) {
        $('header').hide()
        setupAuth();
      }
      setupPersona();
      deform.processCallbacks();
      deform.focusFirstInput()
    }

    var personaSuccess = function (data) {
      var auth = $(data.form.auth).replaceAll('#auth')
      var persona = $(data.form.persona).replaceAll('#persona')
      $('header').show()
      deform.processCallbacks();
      deform.focusFirstInput()
      setupPersona();
    }
    setupPersona();
  </script>
  <script tal:condition="request.user">setupAuth()</script>

</metal:main>

</metal:main>
