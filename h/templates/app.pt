<metal:main use-macro="load: base.pt">

<metal:main fill-slot="head">
    <link rel="stylesheet"
          tal:attributes="href href"
          tal:repeat="href webassets(request, 'app_css') | []" />
</metal:main>

<metal:main fill-slot="body">

  <div id="toolbar">
    <img class="tab-logo"
         src="${request.static_url('h:images/hbar-logo-small.png')}" />
    <form tal:replace="structure form['persona']"/>
  </div>

  <div id="wrapper">
    <header class="annotator-outer">
      <div class="hyp-paper">
        <span metal:use-macro="auth" tal:define="auth load: auth.pt" />
      </div>
    </header>
  </div>

  <script tal:attributes="src src"
          tal:repeat="src webassets(
                      request,
                      'annotator',
                      'd3',
                      'easyXDM',
                      'handlebars',
                      'jwz',
                      'templates',
                      'underscore')"></script>
  <script>
    var annotator = window.Annotator._instance = new Hypothesis(document.body, {
      Heatmap: {}
    })
    var plugins = annotator.plugins

    var setupAuth = function () {
      $('#persona').on('change', function () {
        $(this).submit()
      })

      var action = decodeURIComponent(
        (RegExp('action=(.+?)(&|$)').exec($('#auth').attr('action')) ||
         [,'login']
        )[1]
      )
      $('[data-action]')
        .hide()
        .filter(function () {
          return $(this).data('action') != action
        })
        .show()

      // TODO: use less janky cookie stuff (and below)
      if (document.cookie.indexOf('auth_tkt=') != -1) {
        $('header').hide()
        if (!plugins.Auth) {
          annotator.addPlugin('Auth', {
            tokenUrl: '${request.route_url('token')}'
          })
        }
        plugins.Auth.withToken(plugins.Permissions._setAuthFromToken)
      } else {
        $('header').show()
        plugins.Permissions.setUser(null)
        if (plugins.Auth) {
          plugins.Auth.token = null
          plugins.Auth.updateHeaders()
          delete plugins.Auth
        }
      }
    }

    var authSuccess = function (data) {
      $('#auth').fadeOut(function () {
        $('#persona').replaceWith(data.form.persona)
        $(this).replaceWith($(data.form.auth).fadeIn())
        deform.processCallbacks()
        deform.focusFirstInput()
        setupAuth();
      })
    }
    setupAuth();
  </script>
  <script tal:condition="request.user">setupAuth()</script>

</metal:main>

</metal:main>
