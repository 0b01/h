<!DOCTYPE html>
<html lang="en" metal:use-macro="main_template">
  <head>
    <link rel="stylesheet"
          metal:fill-slot="css_links"
          tal:attributes="href href"
          tal:repeat="href webassets(request, 'app_css') | []" />
  </head>
  <body metal:fill-slot="body">
    <div id="toolbar">
      <div class="tab"></div>
      ${structure: persona.form}
    </div>
    <div id="gutter">
      <header class="dialog sheet">
        <a class="close" onclick="showAuth(false)"
           ><img src="${request.static_url('h:images/delete_1.png')}" /></a>
        <ul class="nav nav-pills right">
          <li><a href="#auth" data-toggle="pill">Log in</a></li>
          <li><a href="#register" data-toggle="pill">Sign up</a></li>
        </ul>
        <div class="tab-content">
          ${structure: layout.forms['auth'].render()}
          ${structure: layout.forms['register'].render()}
        </div>
      </header>
      <div id="wrapper">
      </div>
    </div>
    <script type="text/javascript"
            tal:attributes="src src"
            tal:repeat="src webassets(
                        request,
                        'annotator',
                        'd3',
                        'easyXDM',
                        'handlebars',
                        'jwz',
                        'templates',
                        'underscore')"></script>
    <script type="text/javascript">
      var annotator = window.Annotator._instance = new Hypothesis(document.body, {
        Heatmap: {}
      })
      var plugins = annotator.plugins

      var showAuth = function (show, cb) {
        var $header = $('header'),
            visible = !$header.hasClass('hyp-collapsed')
        if (visible != show) {
          if (show) {
            $header.removeClass('hyp-collapsed')
            // TODO: deform.js is broken -- it selects hidden fields
            $('#auth input[type!="hidden"]').first().focus()
          } else {
            $header.addClass('hyp-collapsed')
          }
          $header.one('webkitTransitionEnd transitionend OTransitionEnd', cb)
        } else {
          if (cb) cb()
        }
      }

      var setupAuth = function (cb) {
        // TODO: use less janky cookie stuff (and below)
        if (document.cookie.indexOf('auth_tkt=') != -1) {
          $('#persona').off('change mousedown').on('change', function () {
            $(this).submit()
          })
          if (!plugins.Auth) {
            annotator.addPlugin('Auth', {
              tokenUrl: '${request.resource_url(request.root, 'access_token')}'
            })
          }
          plugins.Auth.withToken(plugins.Permissions._setAuthFromToken)
          if (cb) cb(true)
        } else {
          $('#persona').off('change mousedown').on('mousedown', function (e) {
            e.preventDefault()
            $('a[href="#auth"]').tab('show')
            showAuth(true)
          })
          plugins.Permissions.setUser(null)
          if (plugins.Auth) {
            plugins.Auth.token = null
            plugins.Auth.updateHeaders()
            delete plugins.Auth
          }
          if (cb) cb(false)
        }
      }

      var authSuccess = function (data) {
        var visible = !$('header').hasClass('hyp-collapsed')
        showAuth(false, function () {
          Object.getOwnPropertyNames(data).map(function (oid) {
            if (data[oid].form) {
              var fragment = $('#' + oid)
                , active = fragment.hasClass('active')
                , form = $(data[oid].form)
              fragment.replaceWith(form)
              if (active) form.addClass('active')
            }
          })
          deform.processCallbacks()
          setupAuth(function (auth) {
            if (visible && !auth) showAuth(true)
          })
        })
      }
      setupAuth()
      showAuth(false)
    </script>
    <script type="text/javascript"
            tal:condition="request.user">setupAuth()</script>
  </body>
</html>
