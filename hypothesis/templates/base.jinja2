{% import "flash_template.jinja2" as flash with context -%}
{% do request.need('hypothesis.resources:site_styles') %}
{% do request.need('js.annotator:annotator') %}
{% do request.need('js.annotator.plugins:auth') %}
{% do request.need('js.annotator.plugins:heatmap') %}
{% do request.need('js.annotator.plugins:store') %}
{% do request.need('js.annotator.plugins:selector') %}
{% do request.need('js.annotator.plugins:unsupported') %}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.1//EN"
    "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-2.dtd">
<!--[if lt IE 9]><html class="ie"><![endif]-->
<!--[if gte IE 9]><!--><html><!--<![endif]-->
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<!--[if lt IE 9]>
  <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
  <title>{{ (('%s - ' % title) if title else '' ) + 'hypothes.is'}}</title>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <link href='http://fonts.googleapis.com/css?family=Sorts+Mill+Goudy:400,400italic' rel='stylesheet' type='text/css'>
  {{ flash.apex_head() }}
</head>
<body>
  <div id="flash-msg">{{ flash.apex_flash() }}</div>
  <div id="header">
    {% if form is defined %}
      {{ form.render(action=action, submit_text=_(action)) | safe }}
      {% if action != 'login' %}
        or <a href="{{ request.route_path('apex_login') }}">{{ _('log in') }}</a>
      {% elif action != 'register' %}
        or <a href="{{ request.route_path('apex_register') }}">{{ _('register') }}</a>
      {% elif action != 'forgot' %}
        or <a href="{{ request.route_path('apex_forgot') }}">{{ _('forgot') }}</a>
      {% endif %}
    {% else %}
      <a href="{{ request.route_path('apex_logout') }}">{{ _('log out') }}</a>
    {% endif %}
    {% if velruse_forms is defined %}
      {% for provider_form in velruse_forms %}
        {{ provider_form.render(
             action='/velruse/%s/login' % provider_form.provider_name,
             submit_text=provider_form.provider_proper_name,
           ) | safe }}
        {% endfor %}
    {% endif %}
  </div>
  <div id="content">{% block content %}{% endblock %}</div>
  <div id="footer">{% block footer %}{% endblock %}</div>
  <script>
    var elem = document.getElementById('content');
    (function ($) {
    {% if request.user is not none %}
      var annotator = new Annotator(elem)
        .addPlugin('Auth', {
          tokenUrl: '{{ request.route_url("token") }}'
        })
    {% else %}
      var annotator = new Annotator(elem, {readOnly: true})
    {% endif %}
        .addPlugin('Unsupported')
        .addPlugin('Store', {
          prefix: '{{ request.route_url("api", subpath="") }}',
          loadFromSearch: {
            uri: document.location.href
          },
          annotationData: {
            uri: document.location.href
          }
        })
        .addPlugin('Selector', {})
        .addPlugin('Heatmap', {
          d3: "http://cdnjs.cloudflare.com/ajax/libs/d3/2.8.1/d3.v2.min.js"
        })
    })(jQuery);
  </script>
</body>
</html>
